<html>
    <head>
        <!-- <link rel="stylesheet" href="index.css"> -->
        <style>
body
{
  background: black;
  color: white;
}
a, .link
{
  color: #9f9;
  text-decoration: none;
  cursor: pointer;
}
a:hover, .link:hover
{
  text-decoration: underline;
}
#selectedDescriptor
{
  margin-top: 3em;
}
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" type="text/javascript"></script>
        <script>var require=()=>{};var module={};</script>
        <script src="./node/core.js" type="text/javascript"></script>
    </head>
    <body>

<div id="app">
    <div id="content"></div>
    <div id="selectedDescriptor"></div>
</div>

<script>




async function importData(jsonPath)
{
  var fetched = await fetch(jsonPath);
  var json = await fetched.json();
  // trusting the source and the format here
  json.nodes.forEach(({id,claims})=>
  {
    var node = Node.makeById(id);
    for(var typeId in claims)
    {
      var to = claims[typeId];
      if(to && to.j) to.j = eval(to.j);
      if(_.isString(to)) to = Node.makeById(to);
      var type = Node.makeById(typeId);
      node.setFromType(type,to);
    }
  });
}





// content.appendChild(_instanciable.executeJsMethod($$('simpleView')));

var _content = document.getElementById("content");
var selectedNode = _instanciable;
var showObject = async (node)=>
{
  var method = 'object.simpleView';
  if(!node) node = selectedNode;
  if(_.isString(node)) 
  {
    var split = node.split('/');
    if(split.length >= 2)
    {
      node = split[0];
      method = split[1];
    }
    node = $$(node);
  }
  if(!node) node = selectedNode;
  selectedNode = node;
  var hash = node.name;
  if(method != 'object.simpleView' && method != 'simpleView')
    hash+= '/'+method;
  location.hash = hash;
  console.log("showObject()","LOAD",node.name,method,'#'+hash);
  _content.innerHTML = '';

  if(!method.includes('.')) method = '.'+method;
  _content.appendChild(htmlToElement(  await Promise.resolve( $$(node,method) )  ));
}

var _selectedDescriptor = document.getElementById("selectedDescriptor");
var selectedDescriptor;
var updateSelectedDescriptor = descriptor=>
{
  console.log("updateSelectedDescriptor()","descriptor",descriptor);
  _selectedDescriptor.innerHTML = '';
  _selectedDescriptor.appendChild(htmlToElement($$(descriptor,'object.htmlSmallDescription')));

  selectedDescriptor = descriptor;
}
var editStringDescriptor = descriptor=>
{
  var value = $$(descriptor,"descriptorTo.resolve");
  var newString = prompt("string value:", value&&value.s);
  if(newString === null) return;
  $$( $$(descriptor,"descriptorTo.from"),$$(descriptor,"descriptorTo.type"),{s:newString} );
  showObjectFromHash();

}
var createInDescriptor = descriptor=>
{
  var instance = $$(descriptor,'descriptorFrom.instanciate');
  showObject(instance);
}

var showObjectFromHash = ()=>showObject(location.hash && location.hash.substring(1) || "instanciable");

(async ()=>
{
  await importData('http://localhost:3000/all');
  window.addEventListener("hashchange", showObjectFromHash);
  showObjectFromHash();
}
)();


</script>


    </body>
</html>