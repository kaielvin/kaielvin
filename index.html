<html>
    <head>
        <!-- <link rel="stylesheet" href="index.css"> -->
        <style>
body
{
  background: black;
  color: white;
}
a, .link
{
  color: #9f9;
  text-decoration: none;
  cursor: pointer;
}
a:hover, .link:hover
{
  text-decoration: underline;
}
#selectedDescriptor
{
  margin-top: 3em;
}
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" type="text/javascript"></script>
        <script src="https://apis.google.com/js/api.js"></script>
    </head>
    <body>

<div id="app">
    <div id="content"></div>
    <div id="selectedDescriptor"></div>
</div>

<script>


/**
 * @param {String} HTML representing a single element
 * @return {Element}
 */
function htmlToElement(html) {
    var template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}

var randHex = function(len=8) {
  var maxlen = 8,
      min = Math.pow(16,Math.min(len,maxlen)-1) 
      max = Math.pow(16,Math.min(len,maxlen)) - 1,
      n   = Math.floor( Math.random() * (max-min+1) ) + min,
      r   = n.toString(16);
  while ( r.length < len ) {
     r = r + randHex( len - maxlen );
  }
  return r;
};

var valueToString = value=>
       !value                 ? 'undefined'
      : value instanceof Node ? value.name
      : value.s               ? 's_'+value.s
      : value.n               ? 'n_'+value.n
      :                         'j_';
      // : value.j               ? 'j_'
      // :                         'b_'+value.b;


var _idToNodeIndex = {};
class Node
{
  constructor(id)
  {
    this.id = id || randHex();
    _idToNodeIndex[this.id] = this;
    this.typeTos = {};
    this.typeFroms = {};
  }
  get name()
  {
    return this.getFromType_string(_strid) || this.id;
  }
  setFromType(type,to)
  {
    // TODO check type.multipleValues and override if not true
    // if(!this.typeTos[type.id]) this.typeTos[type.id] = {};
    // if()

    // removes this from the old to's typeFroms index
    var oldTo = this.typeTos[type.id];
    if(oldTo && oldTo instanceof Node)
    {
      var froms = oldTo.typeFroms[type.id];
      // if(froms) delete froms[this.id];
      if(froms) _.remove(froms,this);
    }

    // reindex strid
    if(type == _strid)
    {
      delete _nodeNameIndex[this.getFromType_string(_strid)];
      _nodeNameIndex[to.s] = this;
    }

    this.typeTos[type.id] = to;

    // add this to the new to's typeFroms index
    if(to instanceof Node)
    {
      var froms = to.typeFroms[type.id];
      // if(!froms) froms = to.typeFroms[type.id] = {};
      // froms[this.id] = true;
      if(!froms) froms = to.typeFroms[type.id] = [];
      // TODO check already in ?
      froms.push(this);
    }

    console.log(_.padEnd(this.name,25),_.padEnd(type.name,15),valueToString(to));
    // console.log(this.id,type.id,to instanceof Node ? to.id
    //   // : to.b !== undefined ? (to.b ? 'bool(true)'Â : 'bool(false)')
    //   : to.s               ? '"'+_.escape(to.s)+'"'
    //   : to.j               ? '*function*'
    //   : to.n               ? 'number('+to.n+')'
    //   :                      '*unknown*' );
  }
  getFromType_to(type)
  {
    return this.typeTos[type.id];
  }
  getFromType_boolean(type)
  {
    var to = this.typeTos[type.id];
    if(!(to instanceof Node)) return false;
    return to === $$('true');
  }
  getFromType_string(type)
  {
    var to = this.typeTos[type.id];
    if(!(to instanceof Object)) return false;
    if(!to.s) return undefined;
    return to.s;
  }
  getFromType_node(type)
  {
    var to = this.typeTos[type.id];
    if(!(to instanceof Node)) return undefined;
    return to;
  }
  getToType_froms(type)
  {
    return this.typeFroms[type.id] || [];
  }

  getFrom_types()
  {
    return _.keys(this.typeTos).map(id=>_idToNodeIndex[id]);
  }
  getTo_types()
  {
    return _.keys(this.typeFroms).map(id=>_idToNodeIndex[id]);
  }

  executeJsMethod(type)
  {
    var jsMethod = type.getFromType_to(makeNode('claimType.resolve'));
    if(!(jsMethod instanceof Object)) return undefined;
    if(!jsMethod.j) return undefined;
    return jsMethod.j(this);
    // var instanciable = _object;
    // var jsMethod = instanciable.typeTos[type.id];
    // if(!(jsMethod instanceof Object)) return undefined;
    // if(!jsMethod.j) return undefined;
    // return jsMethod.j(this);
  }

  $(i2,i3,i4)
  {
    return $$(this,i2,i3,i4);
  }
}

var _nodeNameIndex = {};
var _strid = _nodeNameIndex["object.strid"] = new Node();
_strid.setFromType(_strid,{s:"object.strid"});
function makeNode(name)
{
  if(name instanceof Node) return name;
  var node = _nodeNameIndex[name];
  if(node) return node;
  node = _idToNodeIndex[name];
  if(node) return node;
  node = new Node();
  node.setFromType(_strid,{s:name});
  return _nodeNameIndex[name] = node;
}
function stridToNode(strid)
{
  return _nodeNameIndex[strid];
}
var _object = makeNode("object");
var _anything = makeNode("anything");
var _instanceOf = makeNode("object.instanceOf");
var _instanciable = makeNode("instanciable");
var _claimType = makeNode("claimType");
// var _typeFromOne = makeNode("typeFromOne");
var _typeFrom = makeNode("claimType.typeFrom");
var _typeTo = makeNode("claimType.typeTo");
// var _multipleValues = makeNode("multipleValues");
var _jsMethod = makeNode("jsMethod");
// var _descriptorTo_from = makeNode("descriptorTo_from");
// var _descriptorTo_type = makeNode("descriptorTo_type");
// var _descriptorFrom_to   = makeNode("descriptorFrom_to");
// var _descriptorFrom_type = makeNode("descriptorFrom_type");


/*

"a (b)" implies:
  "a instanceOf b"
  "b instanceOf instanciable"
"a > b > c" implies:
  "b instanceOf claimType"
  "b typeFrom a"
  "b typeTo c"
  "a instanceOf instanciable" if a != object
"a > b > c *" implies:
  "a > b > c"
  "b multipleValues true"
"a < b < c" implies:
  "c > b > a"

*/
function $$(i1,i2,i3,i4)
{
  if(!i1) return new Node();


  /*
  "c a.b" implies:
    "a > a.b > c"
  */
  var matchClaimType = _.isString(i1) && i1.match(/([^\ >]+)\ ([^\.>]+)\.([^.>]+)/);
  // if(matchClaimType)
  //   console.log("$$ OVERRIDE",matchClaimType[2]+' > '+matchClaimType[2]+'.'+matchClaimType[3]+' > '+matchClaimType[1]);
  if(matchClaimType)
    return $$(matchClaimType[2]+' > '+matchClaimType[2]+'.'+matchClaimType[3]+' > '+matchClaimType[1],i2,i3,i4);

  /*
  "a > b > c" implies:
    "b instanceOf claimType"
    "b typeFrom a"
    "b typeTo c"
    "a instanceOf instanciable" if a != object
  "a > b > c *" implies:
    "a > b > c"
    "b multipleValues true"
  */
  var claimFromTo = _.isString(i1) && i1.split(">");
  if(claimFromTo && claimFromTo.length == 3)
  {
    claimFromTo[0] = _.trim(claimFromTo[0]);
    claimFromTo[1] = _.trim(claimFromTo[1]);
    claimFromTo[2] = _.trim(claimFromTo[2]);

    // var singleFrom = _.endsWith(claimFromTo[0],'-');
    // if(singleFrom)
    //   claimFromTo[0] = _.trim(claimFromTo[0].substring(0,claimFromTo[0].length-1));

    var multipleValues = _.endsWith(claimFromTo[2],'*');
    if(multipleValues)
      claimFromTo[2] = _.trim(claimFromTo[2].substring(0,claimFromTo[2].length-1));

    var typeFrom  = makeNode(claimFromTo[0]);
    var claimType = makeNode(claimFromTo[1]);
    var type__To  = makeNode(claimFromTo[2]);

    claimType.setFromType(_instanceOf,_claimType);
    if(typeFrom != _object)
      typeFrom.setFromType(_instanceOf,_instanciable);
    // claimType.setFromType(singleFrom ? _typeFromOne : _typeFrom,typeFrom);
    claimType.setFromType(_typeFrom,typeFrom);
    claimType.setFromType(_typeTo,  type__To);
    if(multipleValues)
      claimType.setFromType($$('claimType.multipleValues'),{b:true});

    if(i2 && _.isFunction(i2))
    {
      $$(claimType,'claimType.functional','true');
      $$(claimType,'claimType.resolve',i2);
    }

    // return claimType;
    return typeFrom;
  }

  /*
  "a (b)" implies:
    "a instanceOf b"
    "b instanceOf instanciable"
  */
  var fromObject;
  var matchInstanceOf = _.isString(i1) && i1.match(/([^\(]+)\(([^\)]+)\)/);
  if(matchInstanceOf)
  {
    var fromObject = makeNode(_.trim(matchInstanceOf[1]));
    var instanciable = makeNode(_.trim(matchInstanceOf[2]));
    fromObject.setFromType(_instanceOf,instanciable);
  }
  


  if(!fromObject) fromObject = makeNode(i1);



  var typeObject;
  if(_.isString(i2) && !i2.includes('.')) i2 = '.'+i2;
  if(_.isString(i2) && i2[0] == '.')
  {
    var instanciable = fromObject.getFromType_node(_instanceOf);
    if(instanciable) typeObject = stridToNode(instanciable.name+i2);
    if(!typeObject) typeObject = stridToNode('object'+i2);
    if(!typeObject) console.error('$$()',i2,"not found on",fromObject.name);
    if(!typeObject) return;
  }
  else typeObject = makeNode(i2);

  // make from type to claim
  if(i2 && i3)
  {
    var to = i3;

    // if(_.isFunction(to))
    //   // $$(fromObject.name+' -> '+typeObject.name+' > jsMethod');
    //   $$(fromObject,makeNode('functional'),makeNode('true'));

    if(_.isFunction(to)) to = {j:to};
    if(_.isString(to)) to = makeNode(to);
    fromObject.setFromType(typeObject,to);
    return fromObject;
  }
  
  // get from type, or execute jsMethod
  if(i2)
  {
    // if(typeObject.getFromType_node(_typeTo) == _jsMethod)
    if(typeObject.getFromType_node(makeNode('claimType.functional')) == makeNode('true'))
      return fromObject.executeJsMethod(typeObject);
    else
    {
      var toValue = fromObject.getFromType_to(typeObject);
      return toValue === undefined ? undefined
           : toValue.s ? toValue.s
           : toValue;
      // return fromObject.getFromType_node(typeObject);
    }
  }

  return fromObject;
}


var valueToHtml = value=>
  value instanceof Node ? $$(value,'object.link')
      : value === undefined ? 'undefined'
      : value.s ? '"'+value.s+'"'
      : value.j ? '*function*'
      // : value.b != undefined ? (value.b?'true':'false')
      : value; // should be number



function makeUnique(typeTos)
{
    // console.log('makeUnique()');
  // perform intersection of all the sets of (to,type)->froms
  // typeTos.forEach(([type,to])=>
  //   console.log('makeUnique()',$$(type,'object.prettyString'),$$(to,'object.prettyString'),$$(to).getToType_froms($$(type)).map( from=> $$(from,'object.prettyString') ) ) );
  var fromss = typeTos.map(([type,to])=>$$(to).getToType_froms($$(type)));
  fromss = _.sortBy(fromss,froms=>froms.length);
  // console.log('makeUnique()',fromss.map(froms=>froms.map( from=> $$(from,'object.prettyString') )));
  var uniques = fromss[0];
  for(var i=1;i<fromss.length && uniques.length > 0;i++)
  {
    uniques = _.intersection(uniques,fromss[i]);
    // console.log('makeUnique()','uniques.length',uniques.length);
  }

    // console.log('makeUnique()','uniques.length',uniques.length,uniques.length&&$$(uniques[0],'object.prettyString'));
  // one or more found
  if(uniques.length > 0) return uniques[0];

  // else create one
  var unique = $$();
  typeTos.forEach(([type,to])=>$$(unique,type,to));
  return unique;
}

// $$('objectSingleton (instanciable)');
// $$('object (objectSingleton)');
// $$('object -> link > jsMethod');
// $$('object -> simpleView > jsMethod');


$$('instanciable (instanciable)');
$$('boolean (instanciable)');
$$('true (boolean)');
$$('false (boolean)');

$$('string object.strid');
$$('instanciable object.instanceOf');

$$('primitive (instanciable)');
$$('string (primitive)');
$$('number (primitive)');
$$('jsMethod (primitive)');

$$('person (instanciable)');
$$('string person.name');
var KaiElvin = $$().$(_instanceOf,'person').$('person.name',{s:'Kai Elvin'});

// $$('claimType > typeFromOne > object');
$$('instanciable claimType.typeFrom');
$$('anything     claimType.typeTo');
$$('boolean      claimType.multipleValues');
$$('boolean      claimType.functional');
$$('jsMethod     claimType.resolve');

$$('string object.prettyString',o=>
{
  var instanciable = o.getFromType_node(_instanceOf);
  var instanciableMethod = instanciable && stridToNode(instanciable.name+'.prettyString');
  return instanciableMethod && $$(o,instanciableMethod) || o.getFromType_string($$('person.name')) || o.name;
});
$$('string object.link',o=>'<a href="#'+o.name+'/'+$$(o,'defaultView')+'">'+$$(o,'object.prettyString')+'</a>');
$$('string object.defaultView',o=>"simpleView");
;

$$('string object.htmlSmallDescription',o=>
{
  var instanciable = o.getFromType_node(_instanceOf);
  var instanciableMethod = instanciable && stridToNode(instanciable.name+'.htmlSmallDescription');
  console.log("object.htmlSmallDescription()","instanciableMethod",instanciable.name+'.htmlSmallDescription',instanciableMethod);
  return $$(o,instanciableMethod || 'object.link')
});

$$('string object.simpleView',o=>
{
  console.log("object.simpleView()","id",o.id);

  var instanciable = o.getFromType_node(_instanceOf);

  var instanciableFromTypes = instanciable &&
    instanciable.getToType_froms($$('claimType.typeFrom'))
    || [];

  var objectFromTypes = _object.getToType_froms($$('claimType.typeFrom'));
  _.pullAll(objectFromTypes,instanciableFromTypes);

  var otherFromTypes = o.getFrom_types();
  _.pullAll(otherFromTypes,instanciableFromTypes);
  _.pullAll(otherFromTypes,objectFromTypes);

  var fromTypeToLi = type=>
    $$(makeUnique([
        [_instanceOf,"descriptorTo"],
        ['descriptorTo.from',o],
        ['descriptorTo.type',type],
      ]),'descriptorTo.htmlList');


  var instanciableToTypes = instanciable &&
    instanciable.getToType_froms($$('claimType.typeTo'))
    || [];

  var objectToTypes = _object.getToType_froms($$('claimType.typeTo'));
  _.pullAll(objectToTypes,instanciableToTypes);

  var otherToTypes = o.getTo_types();
  _.pullAll(otherToTypes,instanciableToTypes);
  _.pullAll(otherToTypes,objectToTypes);

  var toTypeToLi = type=>
    $$(makeUnique([
        [_instanceOf,"descriptorFrom"],
      ['descriptorFrom.to',o],
      ['descriptorFrom.type',type],
      ]),'descriptorFrom.htmlList');

  var elements = [];
  elements.push('<h1>'+$$(o,'object.prettyString')+'</h1>');

  if(instanciable)
  {
    var descriptor = makeUnique([
      [_instanceOf,"descriptorFrom"],
      ['descriptorFrom.to',o],
      ['descriptorFrom.type',_instanceOf],
    ]);

    elements.push('<div>instance of: '+$$(instanciable,'object.link')
        +(instanciable == _instanciable ? ' <span class="link" onclick="createInDescriptor($$(\''+descriptor.id+'\'))">[new]</span>' : '')
      +'</div><br/>');
  }

  elements.push((instanciableFromTypes.length > 0 || instanciableToTypes.length > 0)
    && '<div>as '+$$(instanciable,'object.link')+':</div>');
  elements.push(instanciableFromTypes.length > 0
    && '<ul>'+instanciableFromTypes.map(fromTypeToLi).join('')+'</ul>');
  elements.push(instanciableToTypes.length > 0
    && '<ul>'+instanciableToTypes.map(toTypeToLi).join('')+'</ul>');

  elements.push((objectFromTypes.length > 0 || objectToTypes.length > 0)
    && '<div>as '+$$(_object,'object.link')+':</div>');
  elements.push(objectFromTypes.length > 0
    && '<ul>'+objectFromTypes.map(fromTypeToLi).join('')+'</ul>');
  elements.push(objectToTypes.length > 0
    && '<ul>'+objectToTypes.map(toTypeToLi).join('')+'</ul>');

  elements.push((otherFromTypes.length > 0 || otherToTypes.length > 0)
    && '<div>others:</div>');
  elements.push(otherFromTypes.length > 0
    && '<ul>'+otherFromTypes.map(fromTypeToLi).join('')+'</ul>');
  elements.push(otherToTypes.length > 0
    && '<ul>'+otherToTypes.map(toTypeToLi).join('')+'</ul>');

  elements = elements.filter(_.identity);

  return '<div>'
      +elements.join('\n');
    +'</div>';
});


$$('object    descriptorTo.from');
$$('claimType descriptorTo.type');
$$('anything  descriptorTo.resolve',o=>
{
  var type = o.getFromType_node($$('descriptorTo.type'));
  if(!type) return undefined;
  var from = o.getFromType_node($$('descriptorTo.from'));
  if(!from) return undefined;
  return from.getFromType_to(type);
});
$$('string    descriptorTo.htmlList',o=>
{
  var type = $$(o,'descriptorTo.type');
  var functional = type.getFromType_boolean($$('claimType.functional'));
  var toType = $$(type,'claimType.typeTo');
  var to = !functional && $$(o,'descriptorTo.resolve');
  return '<li>'
    +$$(type,'object.link')
    +_.escape(' > ')
    + (functional
      ? '*functional*'
      : valueToHtml(to)
        + (toType === $$("string")
          ? ' <span class="link" onclick="editStringDescriptor($$(\''+o.id+'\'))">[edit]</span>'
          : ' <span class="link" onclick="updateSelectedDescriptor($$(\''+o.id+'\'))">[select]</span>'
          )
    )
    +'</li>'
});
$$('string descriptorTo.prettyString',o=>
      "["  +$$($$(o,'descriptorTo.from'),'object.prettyString')
     +" > "+$$($$(o,'descriptorTo.type'),'object.prettyString')
     +"]");
$$('string descriptorTo.htmlSmallDescription',o=>
{
  var from = $$(o,'descriptorTo.from');
  var type = $$(o,'descriptorTo.type');
  return '<span>'
      +'Selected: ['+$$(from,'object.link')+_.escape(" > ")+$$(type,'object.link')+']'
      +'<br/><span class="link" onclick="createInDescriptor($$(\''+o.id+'\'))">[new]</span>'
    +'</span>';
});

$$('object    descriptorFrom.to');
$$('claimType descriptorFrom.type');
$$('object*   descriptorFrom.resolve',o=>
{
  var type = $$(o,'descriptorFrom.type');
  if(!type) return [];
  var to = $$(o,'descriptorFrom.to');
  if(!to) return [];
  return to.getToType_froms(type);
});
$$('object    descriptorFrom.instanciate',o=>
{
  var type = $$(o,'descriptorFrom.type');
  if(!type) return undefined;
  var to = $$(o,'descriptorFrom.to');
  if(!to) return undefined;
  var instance = new Node();
  $$(instance,type,to);
  return instance;
});
$$('string    descriptorFrom.htmlList',o=>
{
  var type = $$(o,'descriptorFrom.type');
  var froms = $$(o,'descriptorFrom.resolve');
  var truncated = froms.length > 12;
  if(truncated) froms = _.slice(froms,0,12);

  return '<li>'
    +$$(type,'object.link')
    +_.escape(' < ')
    +(froms.length == 0 ? 'none' : froms.map(o=>$$(o,'object.link')).join(', '))
    +(truncated ? ', (â¦)' : '')
    +' <span class="link" onclick="updateSelectedDescriptor($$(\''+o.id+'\'))">[select]</span>'
    +'</li>'
});
$$('string descriptorFrom.prettyString',o=>
      "["  +$$($$(o,'descriptorFrom.to'  ),'object.prettyString')
     +" < "+$$($$(o,'descriptorFrom.type'),'object.prettyString')
     +"]");
$$('string descriptorFrom.htmlSmallDescription',o=>
{
  var to   = $$(o,'descriptorFrom.to');
  var type = $$(o,'descriptorFrom.type');
  // var froms = $$(o,'descriptorFrom.resolve');
  // console.log("descriptorFrom.onSelect()","o.id",o.id,"froms",froms.map(o=>o.name).join(', '));
  console.log("descriptorFrom.htmlSmallDescription()","descriptor",o,$$(to,'object.link')+_.escape(" < ")+$$(type,'object.link'));
  return '<span>'
      +'Selected: ['+$$(to,'object.link')+_.escape(" < ")+$$(type,'object.link')+']'
      +'<br/><span class="link" onclick="createInDescriptor($$(\''+o.id+'\'))">[new]</span>'
    +'</span>';
});



$$('');

















function authenticate() {
  return gapi.auth2.getAuthInstance()
      .signIn({scope: "https://www.googleapis.com/auth/youtube.readonly"})
      .then(function() { console.log("Sign-in successful"); },
            function(err) { console.error("Error signing in", err); });
}
function loadClient() {
  gapi.client.setApiKey("AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc");
  return gapi.client.load("https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest")
      .then(function() { console.log("GAPI client loaded for API"); },
            function(err) { console.error("Error loading GAPI client for API", err); });
}
  gapi.load("client:auth2", function() {
    gapi.auth2.init({client_id: "YOUR_CLIENT_ID"});
  });
// authenticate().then(loadClient);

$$('YoutubeVideo (instanciable)');
$$('string YoutubeVideo.title');
$$('yLuOzNeHw5I').$(_instanceOf,"YoutubeVideo");


$$('string YoutubeVideo.defaultView',o=>"page");
$$('string YoutubeVideo.page',async o=>
{
  if(!$$(o,'YoutubeVideo.title'))
  {
    var fetched = await fetch('https://www.googleapis.com/youtube/v3/videos?id='+o.name+'&key=AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc&part=snippet,contentDetails,statistics,status');
    var snippet = await fetched.json();
    snippet = snippet && snippet.items;
    snippet = snippet && snippet[0];
    snippet = snippet && snippet.snippet;
    if(snippet && snippet.title) o.$('title',{s:snippet.title});

    // var fetched2 = await fetch('https://www.googleapis.com/youtube/v3/playlists?part=id%2Csnippet&channelId=UCDDe2Yh15Yj4ljU_2f311mQ');
    // var snippet2 = await fetched2.json();
    // console.log(snippet2);
  }
  return '<div>'
      +'<h1>'+($$(o,'title')||o.name)+'</h1>'
      +'<iframe width="1000" height="600" src="https://www.youtube.com/embed/'+o.name+'" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>'
    +'</div>';
});


// https://www.youtube.com/oembed?format=json&amp;url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DnnVq6gmatHU
// https://www.googleapis.com/youtube/v3/videos?id=nnVq6gmatHU&key=AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc&part=snippet,contentDetails,statistics,status
//https://www.youtube.com/embed/HIbAz29L-FA?modestbranding=1&playsinline=0&showinfo=0&enablejsapi=1&origin=https%3A%2F%2Fintercoin.org&widgetid=1
// var url = new URL('https://www.youtube.com/watch?v=PZozMO3wWf&l=01234567');
// console.log(url,url.searchParams.keys(),url.searchParams.get('v'));
// for (let p of url.searchParams) {
//   console.log(p);
// }
/*


*/



























// content.appendChild(_instanciable.executeJsMethod($$('simpleView')));

var _content = document.getElementById("content");
var selectedNode = _instanciable;
var showObject = async (node)=>
{
  var method = 'object.simpleView';
  if(!node) node = selectedNode;
  if(_.isString(node)) 
  {
    var split = node.split('/');
    if(split.length >= 2)
    {
      node = split[0];
      method = split[1];
    }
    node = $$(node);
  }
  if(!node) node = selectedNode;
  selectedNode = node;
  var hash = node.name;
  if(method != 'object.simpleView' && method != 'simpleView')
    hash+= '/'+method;
  location.hash = hash;
  console.log("showObject()","LOAD",node.name,method,'#'+hash);
  _content.innerHTML = '';

  if(!method.includes('.')) method = '.'+method;
  _content.appendChild(htmlToElement(  await Promise.resolve( $$(node,method) )  ));
}

var _selectedDescriptor = document.getElementById("selectedDescriptor");
var selectedDescriptor;
var updateSelectedDescriptor = descriptor=>
{
  console.log("updateSelectedDescriptor()","descriptor",descriptor);
  _selectedDescriptor.innerHTML = '';
  _selectedDescriptor.appendChild(htmlToElement($$(descriptor,'object.htmlSmallDescription')));

  selectedDescriptor = descriptor;
}
var editStringDescriptor = descriptor=>
{
  var value = $$(descriptor,"descriptorTo.resolve");
  var newString = prompt("string value:", value&&value.s);
  if(newString === null) return;
  $$( $$(descriptor,"descriptorTo.from"),$$(descriptor,"descriptorTo.type"),{s:newString} );
  showObject();

}
var createInDescriptor = descriptor=>
{
  var instance = $$(descriptor,'descriptorFrom.instanciate');
  showObject(instance);
}

var showObjectFromHash = ()=>showObject(location.hash && location.hash.substring(1) || "instanciable");
window.addEventListener("hashchange", showObjectFromHash);
showObjectFromHash();




// var list = ["a","b","c","d","e"];

// function makeList(c)
// {
//   var ul = document.createElement("ul");
//   c.forEach(e=>
//   {
//     var li = document.createElement("li");
//     var text = document.createTextNode(e);
//     li.appendChild(text);
//     ul.appendChild(li);
//   });
//   return ul;
// }

// var content = document.getElementById("content");
// content.appendChild(makeList(list));
























</script>


    </body>
</html>