<html>
    <head>
        <!-- <link rel="stylesheet" href="index.css"> -->
        <style>
body
{
  background: black;
  color: #bbb;
  font-family: Roboto, Arial, sans-serif;
}
input
{
  color: #bbb;
  background: #333;
}
input:focus
{
  outline: none;
}
a, .link
{
  /*color: #8d8;*/
  text-decoration: none;
  cursor: pointer;
  color: #bbb;
  text-decoration-line: underline;
  text-decoration-color: #ffffff22;
}
/*a:hover, .link:hover
{
  text-decoration: underline;
}*/
#selectedDescriptor
{
  margin-top: 3em;
}

.items
{
  display: grid;
  grid-template-columns: auto auto auto;
  grid-column-gap: 10px;
  grid-row-gap: 10px;
}

.items > div
{
    /*width: 100%;*/
  /*padding-bottom: 70%;*/
  height: 17em;
}
.items img
{
  object-fit: cover;
  width: 100%;
  height: 14em;  
}

:root {
  --youtube-row-unit: 1em;
}

.rowView
{
  display: flex;
  flex-direction: row;
  padding: calc(var(--youtube-row-unit)/4);
}
.youtube.rowView img
{
  object-fit: cover;
  width:        calc(var(--youtube-row-unit)*8);
  height:       calc(var(--youtube-row-unit)*4*1.1);
  margin-right: calc(var(--youtube-row-unit)/4);
}
.youtube.rowView > div
{
  margin: calc(var(--youtube-row-unit)/4);
}
.rowView .title
{
  font-weight: bold;
  margin-bottom: calc(var(--youtube-row-unit)/4);
}
.rowView .tags, .rowView .subtitle
{
  font-size: 0.8em;
}

#header
{
  display: flex;
  flex-direction: row;
  align-items: center;
}
#header form
{
  margin: 0;
}

#headerSearch
{
  background: #222;
  width: min(70vw, 50em);
  margin: 0.4em;
  padding: 0 0.8em;
  height: 2.3em;
  border: 0;
  border-radius: 0.2em;
}

#searchResults
{
  position: relative;
}
#searchResultsContainer
{
  position: absolute;
  background: #111;
  padding: 0.8em;
  border-radius: 0.4em;
  min-width: 70vw;
  visibility: hidden;
}



        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" type="text/javascript"></script>
        <script src="https://cdn.jsdelivr.net/npm/minisearch@2.2.0/dist/umd/index.min.js"></script>
        <script>var require=()=>{};var module={};</script>
        <script src="./node/core.js" type="text/javascript"></script>
    </head>
    <body>

<div id="app">
    <div id="header">
      <a href="#kaisHome">[h]</a>
      <form onsubmit="onHeaderSearch()"><input type="text" id="headerSearch" oninput="onHeaderSearchChanged()" autocomplete="off" /></form>
      <div id="searchResults"><div id="searchResultsContainer"></div></div>
    </div>
    <div id="content"></div>
    <div id="selectedDescriptor"></div>
</div>

<script>
var wait = ms => new Promise((r, j)=>setTimeout(r, ms))
var resolvablePromise = () =>
{
  var resolve,reject;
  var associate = (r, j)=>{resolve = r;reject = j}
  var promise = new Promise(associate);
  promise.resolve = resolve;
  promise.reject = reject;
  return promise;
}
function findParent(tagname,el){
  while (el){
    if ((el.nodeName || el.tagName).toLowerCase()===tagname.toLowerCase()){
      return el;
    }
    el = el.parentNode;
  }
  return null;
}

function htmlToElement(html) {
    var template = document.createElement('template');
    if(!html) html = '</span>undefinedHtml</span>';
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}




var loggedUser;

const socket = new WebSocket('ws://localhost:8080');

// Connection opened
socket.addEventListener('open', function (event)
{
});

var _wsRequestPromises = {};
socket.addEventListener('message', function (event)
{
  console.log('Message from server ', event.data);
  var json = JSON.parse(event.data);
  _wsRequestPromises[json.requestId].resolve(json);
});

async function wsFetch(request)
{
  request.requestId = randHex();
  var promise = resolvablePromise();
  _wsRequestPromises[request.requestId] = promise;
  socket.send(JSON.stringify(request));
  var response = await promise;
  importDataAsArray(response.data);
  delete _wsRequestPromises[request.requestId];
  return response;
}





async function onHeaderSearch()
{
  var input = document.getElementById('headerSearch').value;
  var youtubeVideoUrlRegex = /https:\/\/www.youtube.com\/watch\?v=([a-zA-Z0-9\-]+)/;
  var youtubeVideoUrlMatch = input.match(youtubeVideoUrlRegex);
  if(youtubeVideoUrlMatch)
  {
    var vid = youtubeVideoUrlMatch[1];
    // var response = await wsFetch({multiple:false,descriptor:[["instanceOf","YoutubeVideo"],["strid",vid]]});
    var response = await wsFetch({request:"makeYouTubeVideo",vid});
    showObject(response.videoId);
  }
  document.getElementById('headerSearch').value = '';
}
var searchResultsContainer = document.getElementById('searchResultsContainer');
var searchInput = document.getElementById('headerSearch');
async function onHeaderSearchChanged()
{
  searchResultsContainer.innerHTML = '';
  var results = fulltextSearch.search(searchInput.value);
  if(results.length > 25) results = results.slice(0,25);
  results = results.map(({id})=>$$(id));

  results.forEach(result=>
  {
    searchResultsContainer.appendChild(htmlToElement(result.$('rowView')));
  });

  searchResultsContainer.style.visibility = results.length > 0 ? "visible" : "hidden";
}

document.addEventListener('keyup', (e) => {
  if(e.key == 'Escape')
  {
    clearHeaderSearch();
  }
  if(searchInput !== document.activeElement)
  {
    var menu = document.getElementsByClassName("menu")[0];
    console.log(menu instanceof Element);
    console.log(menu);
    var options = menu && menu.getElementsByClassName("option");
    options = options && Array.prototype.slice.call(options) || [];
    console.log(options);

    options = options && options.map(option=>
      {
        var links = option.getElementsByTagName('a');
        var link = links && links[0];
        // console.log(link);
        // console.log(link.href);
        return link && link.href;
      });

    if(e.key == '.')               location.hash = "kaisHome";
    if(e.key == '0' && options[0]) window.location.href = options[0];
    else if(e.key == '0')          location.hash = "kaisHome";
    // if(e.key == '0'              ) location.hash = "kaisHome";
    // if(e.key == '9' && options[0]) location.hash = options[0].substring(1);
    // if(e.key == '6' && options[1]) location.hash = options[1].substring(1);
    // if(e.key == '3' && options[2]) location.hash = options[2].substring(1);
    if(e.key == '1' && options[1]) window.location.href = options[1];
    if(e.key == '2' && options[2]) window.location.href = options[2];
    if(e.key == '3' && options[3]) window.location.href = options[3];
  }
});

function clearHeaderSearch()
{
  // if(searchInput === document.activeElement)
  var needed = searchResultsContainer.style.visibility == 'visible'
    || searchInput.value != '';

  searchResultsContainer.style.visibility = "hidden";
  searchInput.value = '';

  return needed;
}















async function importDataAsArray(json)
{
  json.forEach(({id,claims,claimsFrom})=>
  {
    var node = Node.makeById(id);
    for(var typeId in claims)
    {
      var type = Node.makeById(typeId);

      var set = claims[typeId].set;
      // if(set) console.log('importDataAsArray() set',typeId,JSON.stringify(set,null,'    '));
      if(set)
        _.keys(set).forEach(toId=>
          node.addClaim(  new Claim(node,type,Node.makeById(toId),Node.makeById(set[toId].claimer),set[toId].date), true  )
        );
      else
      {
        var {to,claimer,date} = claims[typeId];
        if(to && to.j) to.j = eval('('+to.j+')');
        if(_.isString(to)) to = Node.makeById(to);

        node.addClaim(  new Claim(node,type,to,Node.makeById(claimer),date)  );
      }

      if(claimsFrom) for(var typeId in claimsFrom)
        claimsFrom[typeId].forEach(fromId=>
      {

      } );
    }

    if(claimsFrom)
    for(var typeId in claimsFrom)
    {
      var type = Node.makeById(typeId);
      var {from,claimer,date} = claimsFrom[typeId];
      from = Node.makeById(from);
      from.addClaim(  new Claim(from,type,node,Node.makeById(claimer),date)  );
    }

  });

  console.log('importDataAsArray()',JSON.stringify(json,null,'    '));
}
async function importData(jsonPath)
{
  var fetched = await fetch(jsonPath);
  var json = await fetched.json();
  // trusting the source and the format here
  importDataAsArray(json.nodes);

  // var script = await readFile("./scripts/"+scriptFileName, {encoding: 'utf8'});
  // // var script = babel.transform(script, { "ast": false, "presets": ["stage-0"] }).code;

  // // eval(script);
  // script = new vm.Script(script, {
  //   filename: scriptFileName, // filename for stack traces
  //   lineOffset: 0, // line number offset to be used for stack traces
  //   columnOffset: 0, // column number offset to be used for stack traces
  //   displayErrors: true,
  //   // timeout: 1000 // ms
  // });
  // // script.runInContext(context);
  // var promise = script.runInThisContext(Object.assign({
  //   require: require,
  //   console: console,
  //   params,
  // }));
  // await promise;

}





document.addEventListener("click", e=>
{
  var aEl = findParent('a',e.target || e.srcElement);
  if (!aEl) return;
  var url = aEl.href;
  var hash = url.split('#');
  if(hash.length == 0) return;
  hash = _.last(hash);
  if(hash.includes('/')) return; // TODO, maybe
  var node = $$(hash);
  if(!node) console.error("on click,","unknown node",hash);
  if(!node) return;
  var instanciable = node.$('instanceOf');
  if(instanciable && instanciable == $$('tag'))
  {
    var descriptor = makeUnique([
        ['object.instanceOf','descriptorFrom'],
        ['descriptorFrom.to',node],
        ['descriptorFrom.type','object.tags'],
      ])
    var collection = makeUnique([
        ['object.instanceOf','collection'],
        ['collection.descriptor',descriptor],
      ])
    showObject(collection);
    e.preventDefault();
    e.stopPropagation();
  }
  if(instanciable && instanciable == $$('YoutubeChannel'))
  {
    var descriptor = makeUnique([
        ['object.instanceOf','descriptorFrom'],
        ['descriptorFrom.to',node],
        ['descriptorFrom.type','YoutubeVideo.channel'],
      ])
    var collection = makeUnique([
        ['object.instanceOf','collection'],
        ['collection.descriptor',descriptor],
      ])
    showObject(collection);
    e.preventDefault();
    e.stopPropagation();
  }
  console.log("clicked",url);
});

// content.appendChild(_instanciable.executeJsMethod($$('simpleView')));

var _content = document.getElementById("content");
var selectedNode = _instanciable;
var showObject = async (node,updateHash=true)=>
{
  clearHeaderSearch();

  // var method = 'object.simpleView';
  var method;
  if(!node) node = selectedNode;
  if(_.isString(node)) 
  {
    var split = node.split('/');
    if(split.length >= 2)
    {
      node = split[0];
      method = split[1];
    }
    node = $$(node);
  }
  if(!node) node = selectedNode;
  selectedNode = node;
  var hash = node.name;
  var instanciable = node.$('instanceOf');
  var defaultMethod = instanciable && instanciable.$('defaultPageView') || 'simpleView';
  if(!method) method = defaultMethod;
  if(method != defaultMethod)
    hash+= '/'+method;
  if(updateHash) location.hash = hash;
  var methodObject = strToType(method,node);
  var html = methodObject && await node.$ex(methodObject);
  console.log("showObject()","LOAD",node.name,method,'#'+hash,
    "instanciable",instanciable&&instanciable.name,
    "method",methodObject&&methodObject.name);
  console.log("showObject()","LOAD",html);
  _content.innerHTML = '';

  // if(!method.includes('.')) method = '.'+method;
  // _content.appendChild(htmlToElement(  await Promise.resolve( $$(node,method) )  ));
  _content.appendChild(htmlToElement(  html  ));
}

var _selectedDescriptor = document.getElementById("selectedDescriptor");
var selectedDescriptor;
var updateSelectedDescriptor = descriptor=>
{
  console.log("updateSelectedDescriptor()","descriptor",descriptor);
  _selectedDescriptor.innerHTML = '';
  _selectedDescriptor.appendChild(htmlToElement($$(descriptor,'object.htmlSmallDescription')));

  selectedDescriptor = descriptor;
}
var editStringDescriptor = descriptor=>
{
  var value = $$(descriptor,"descriptorTo.resolve");
  var newString = prompt("string value:", value&&value.s);
  if(newString === null) return;
  $$( $$(descriptor,"descriptorTo.from"),$$(descriptor,"descriptorTo.type"),{s:newString} );
  showObjectFromHash();

}
var createInDescriptor = descriptor=>
{
  var instance = $$(descriptor,'descriptorFrom.instanciate');
  showObject(instance);
}

var showObjectFromHash = ()=>showObject(location.hash && location.hash.substring(1) || "instanciable",false);




// async function fetchYoutubePlaylist(playlistId,results=[],pageToken=undefined)
// {
//   console.log("fetchYoutubePlaylist()","pageToken",pageToken);
//   var path = 'https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&key=AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc&playlistId='+playlistId+'&maxResults=50';
//   if(pageToken) path+= '&pageToken='+pageToken;
//   var fetched = await fetch(path);
//   var json = await fetched.json();
//   json.items.forEach(item=>
//   {
//     var vid = item.snippet.resourceId.videoId;
//     console.log("fetchYoutubePlaylist()","videoId",vid);
//     results.push(vid);
//     $$(vid).$(_instanceOf,"YoutubeVideo").$('YoutubeVideo.title',{s:item.snippet.title});
//   });
//   if(json.nextPageToken) await fetchYoutubePlaylist(playlistId,results,json.nextPageToken);
//   return results;
//   // console.log("json",json);
// }
// async function fetchYoutubePlaylists(channelId,results=[],pageToken=undefined)
// {
//   console.log("fetchYoutubePlaylists()","pageToken",pageToken);
//   var path = 'https://www.googleapis.com/youtube/v3/playlists?part=snippet&key=AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc&channelId='+channelId+'&maxResults=50';
//   if(pageToken) path+= '&pageToken='+pageToken;
//   var fetched = await fetch(path);
//   var json = await fetched.json();
//   json.items.forEach(item=>
//   {
//     var pid = item.id;
//     console.log("fetchYoutubePlaylists()","playlistId",pid);
//     results.push(pid);
//     $$(pid).$(_instanceOf,"YoutubePlaylist").$('YoutubePlaylist.title',{s:item.snippet.title});
//   });
//   if(json.nextPageToken) await fetchYoutubePlaylists(channelId,results,json.nextPageToken);
//   return results;
//   // console.log("json",json);
// }

async function fetchYoutubeData(vid='IK7nBOLYzdE')
{
  var path = 'https://cors-anywhere.herokuapp.com/https://www.youtube.com/watch?v='+vid;
  var fetched = await fetch(path);

  var text = await fetched.text();
  var match = text.match(/window\[\"ytInitialPlayerResponse\"\] = (.*)/);
  if(!match) throw new Error('no json information found');

  var json = match[1];
  json = json.substring(0,json.length-1); // removes end ';'
  json = JSON.parse(json);

  // console.log('FOUND',json);
  // console.log('FOUND',JSON.stringify(json,null,'    '));

  var videoDetails = json.videoDetails;
  var microformat = json.microformat;
  var playerMicroformatRenderer = microformat.playerMicroformatRenderer;

  var processedJson = {};
  processedJson.fetchDate = new Date();
  processedJson.title = videoDetails.title;
  processedJson.lengthSeconds = Number(videoDetails.lengthSeconds);
  processedJson.averageRating = videoDetails.averageRating;
  processedJson.viewCount = Number(videoDetails.viewCount);
  processedJson.publishDate = new Date(playerMicroformatRenderer.publishDate);
  processedJson.uploadDate = new Date(playerMicroformatRenderer.uploadDate);
  processedJson.description = playerMicroformatRenderer.description.simpleText;
  processedJson.keywords = videoDetails.keywords;
  processedJson.channelId = videoDetails.channelId;
  processedJson.author = videoDetails.author;
  processedJson.ownerChannelName = playerMicroformatRenderer.ownerChannelName;

  var result = {};
  result.sourceHtml = text;
  result.extractedJson = json;
  result.processedJson = processedJson;

  return result;
}

(async ()=>
{
  // var fetched = await fetch('https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=PLfoEg9YVcQQS14MaRPjRdYM_Y-HwoQFPJ&key=AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc&pageToken=CAUQAQ&maxResults=5');
  // var json = await fetched.json();
  // console.log("json",json);
  await importData('http://localhost:3000/all');

  loggedUser = $$('person').$froms('instanceOf').find(u=>u.$('title') == 'Kai Elvin');
  console.log("loggedUser",loggedUser&&loggedUser.$('title'));

  // var playlist = await fetchYoutubePlaylists('UCDDe2Yh15Yj4ljU_2f311mQ');
  // fetchYoutubePlaylist('PLfoEg9YVcQQS14MaRPjRdYM_Y-HwoQFPJ');

  window.addEventListener("hashchange", showObjectFromHash);
  showObjectFromHash();

  // fetchYoutubeData('xWggTb45brM');
}
)();


</script>


    </body>
</html>