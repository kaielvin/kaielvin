<html>
    <head>
        <!-- <link rel="stylesheet" href="index.css"> -->

        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/codemirror.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/codemirror.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/theme/material-darker.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/mode/javascript/javascript.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/hint/show-hint.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/hint/javascript-hint.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/hint/show-hint.min.css">

        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/scroll/simplescrollbars.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/scroll/simplescrollbars.min.css">

        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/comment/comment.min.js"></script>
        <style>
body
{
  background: black;
  color: #bbb;
  font-family: Roboto, Arial, sans-serif;
}
input
{
  color: #bbb;
  background: #333;
}
input:focus
{
  outline: none;
}
a, .link
{
  /*color: #8d8;*/
  text-decoration: none;
  cursor: pointer;
  color: #bbb;
  text-decoration-line: underline;
  text-decoration-color: #ffffff22;
}
h1 small
{
  color: #333;
  font-size: 0.5em;
}
/*a:hover, .link:hover
{
  text-decoration: underline;
}*/
#selectedDescriptor
{
  margin-top: 3em;
}

.items
{
  display: grid;
  grid-template-columns: auto auto auto;
  grid-column-gap: 10px;
  grid-row-gap: 10px;
}

.items > div
{
    /*width: 100%;*/
  /*padding-bottom: 70%;*/
  height: 17em;
}
.items img
{
  object-fit: cover;
  width: 100%;
  height: 14em;  
}

:root {
  --youtube-row-unit: 1em;
}

.rowView
{
  display: flex;
  flex-direction: row;
  padding: calc(var(--youtube-row-unit)/4);
}
.youtube.rowView img
{
  object-fit: cover;
  width:        calc(var(--youtube-row-unit)*8);
  height:       calc(var(--youtube-row-unit)*4*1.1);
  margin-right: calc(var(--youtube-row-unit)/4);
}
.youtube.rowView > div
{
  margin: calc(var(--youtube-row-unit)/4);
}
.rowView .title
{
  font-weight: bold;
  margin-bottom: calc(var(--youtube-row-unit)/4);
}
.rowView .tags, .rowView .subtitle
{
  font-size: 0.8em;
}

#header
{
  display: flex;
  flex-direction: row;
  align-items: center;
}
#header form
{
  margin: 0;
}

#headerSearch
{
  background: #222;
  width: min(70vw, 50em);
  margin: 0.4em;
  padding: 0 0.8em;
  height: 2.3em;
  border: 0;
  border-radius: 0.2em;
}

#searchResults
{
  position: relative;
}
#searchResultsContainer
{
  position: absolute;
  background: #111;
  padding: 0.8em;
  border-radius: 0.4em;
  min-width: 70vw;
  visibility: hidden;
}


.CodeMirror-overlayscroll-horizontal div, .CodeMirror-overlayscroll-vertical div
{
  background: #ffffff33;
}



        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" type="text/javascript"></script>
        <script src="https://cdn.jsdelivr.net/npm/minisearch@2.2.0/dist/umd/index.min.js"></script>
        <script src="https://unpkg.com/idb@5.0.2/build/iife/index-min.js"></script>
        <script>var require=()=>{};var module={};</script>
        <script src="core.js" type="text/javascript"></script>
    </head>
    <body>

<div id="app">
    <div id="header">
      <a href="#kaisHome">[h]</a>
      <span class="link" onclick="bookmarkThis()">[b]</span>
      <div>
        <form onsubmit="onHeaderSearch()"><input type="text" id="headerSearch" oninput="onHeaderSearchChanged()" autocomplete="off" /></form>
        <div id="searchResults"><div id="searchResultsContainer"></div></div>
      </div>
    </div>
    <div id="content"></div>
    <div id="selectedDescriptor"></div>
    <textarea id="codeEditor"></textarea>
</div>

<script>
var wait = ms => new Promise((r, j)=>setTimeout(r, ms))
var resolvablePromise = () =>
{
  var resolve,reject;
  var associate = (r, j)=>{resolve = r;reject = j}
  var promise = new Promise(associate);
  promise.resolve = resolve;
  promise.reject = reject;
  return promise;
}
function findParent(tagname,el){
  while (el){
    if ((el.nodeName || el.tagName).toLowerCase()===tagname.toLowerCase()){
      return el;
    }
    el = el.parentNode;
  }
  return null;
}

function htmlToElement(html) {
    var template = document.createElement('template');
    if(!html) html = '</span>undefinedHtml</span>';
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}










var claimsDB;
async function openClaimsDB()
{
  claimsDB = await idb.openDB("claims", 1, {
    upgrade(db, oldVersion, newVersion, transaction) {
      db.createObjectStore('claims', { keyPath: 'id' });
    },
  });

}


var persistedCount = 0;
function reportPersistedNow()
{
  console.log("reportPersistedNow()","persisted",persistedCount,"claims");
  persistedCount = 0;
}
var reportPersistedDebounced = _.throttle(reportPersistedNow,2000);
function reportPersisted()
{
  persistedCount++;
  reportPersistedDebounced();
}

async function persistClaim(claim)
{
  var claimJson = claim.toCompactJson();
  claimJson.id = claim.id;
  await claimsDB.put('claims', claimJson);
  reportPersisted();
  // console.log("persistClaim()","claim",claim.id,claim.idStr,"persisted");
}

// Claim.onNewClaim = persistClaim;
var _skipPersistLocal = false;
var _skipPersistServer = false;
Claim.onNewClaim = claim=>
{
  if(!_skipPersistLocal) console.log("Claim.onNewClaim()","claim",claim.id,claim.idStr,"persistClaim()");
  if(!_skipPersistLocal) persistClaim(claim);
  if(!_skipPersistServer) console.log("Claim.onNewClaim()","claim",claim.id,claim.idStr,"sendClaimToServer()");
  if(!_skipPersistServer) sendClaimToServer(claim);
};

async function loadClaimsForDB()
{
  _skipPersistServer = true;
  _skipPersistLocal = true;
  console.log("loadClaimsForDB()","_skipPersistLocal",_skipPersistLocal);
  var claimJsons = await claimsDB.getAll('claims')
  for(var claimJson of claimJsons)
    var claim = Claim.fromCompactJson(claimJson);
  _skipPersistLocal = false;
  _skipPersistServer = false;
  console.log("loadClaimsForDB()","_skipPersistLocal",_skipPersistLocal);
}







async function importData(jsonPath)
{
  _skipPersistServer = true;
  var fetched = await fetch(jsonPath);
  var json = await fetched.json();
  importClaims(json.compactJson);
  _skipPersistServer = false;

}




var loggedUser;

const socket = new WebSocket('ws://localhost:8080');

// Connection opened
socket.addEventListener('open', function (event)
{
});

var _wsRequestPromises = {};
socket.addEventListener('message', function (event)
{
  console.log('Message from server ', event.data);
  var json = JSON.parse(event.data);
  _wsRequestPromises[json.requestId].resolve(json);
});

async function wsFetch(request)
{
  request.requestId = randHex();
  var promise = resolvablePromise();
  _wsRequestPromises[request.requestId] = promise;
  socket.send(JSON.stringify(request));
  var response = await promise;
  _skipPersistServer = true;
  if(response.claims) importClaims(response.claims);
  _skipPersistServer = false;
  delete _wsRequestPromises[request.requestId];
  return response;
}




var claimsToServerStore;
function sendClaimsToServerNow()
{
  console.log("sendClaimsToServerNow()","claim count",claimsToServerStore.length);
  var compactJson = claimsToServerStore.toCompactJson();
  claimsToServerStore = null;
  wsFetch({claims:compactJson}); // ignore the answer, assumes it went through
}
sendClaimsToServerDebounced = _.debounce(sendClaimsToServerNow,500,{maxWait:3000});

function sendClaimToServer(claim)
{
  if(!claimsToServerStore) claimsToServerStore = new ClaimStore();
  claimsToServerStore.addClaim(claim);
  sendClaimsToServerDebounced();
}

















async function onHeaderSearch()
{
  var input = document.getElementById('headerSearch').value;
  var youtubeVideoUrlRegex = /https:\/\/www.youtube.com\/watch\?v=([a-zA-Z0-9\-]+)/;
  var youtubeVideoUrlMatch = input.match(youtubeVideoUrlRegex);
  if(youtubeVideoUrlMatch)
  {
    var vid = youtubeVideoUrlMatch[1];
    // var response = await wsFetch({multiple:false,descriptor:[["instanceOf","YoutubeVideo"],["strid",vid]]});
    var response = await wsFetch({request:"makeYouTubeVideo",vid});
    showObject(response.videoId);
  }
  document.getElementById('headerSearch').value = '';
}
var searchResultsContainer = document.getElementById('searchResultsContainer');
var searchInput = document.getElementById('headerSearch');
async function onHeaderSearchChanged()
{
  searchResultsContainer.innerHTML = '';
  var results = fulltextSearch.search(searchInput.value);
  if(results.length > 25) results = results.slice(0,25);
  results = results.map(({id})=>$$(id));

  results.forEach(result=>
  {
    searchResultsContainer.appendChild(htmlToElement(result.$('rowView')));
  });

  searchResultsContainer.style.visibility = results.length > 0 ? "visible" : "hidden";
}

function clearHeaderSearch()
{
  // if(searchInput === document.activeElement)
  var needed = searchResultsContainer.style.visibility == 'visible'
    || searchInput.value != '';

  searchResultsContainer.style.visibility = "hidden";
  searchInput.value = '';

  return needed;
}










document.addEventListener('keydown', (e) => {
  
  // console.log("keydown",e.key,e.ctrlKey);
  if(myCodeMirror.hasFocus())
  {
    if(e.key == 'Escape')
    {
      console.log("escaping editor…","myCodeMirrorUnsaved",myCodeMirrorUnsaved);
      if(!myCodeMirrorUnsaved || confirm("There are unsaved change. Exit editor anyway?"))
        myCodeMirrorElStyle.visibility = "hidden";
      return e.preventDefault();
    }
    if((e.key == 's' || e.key == 't') && e.ctrlKey)
    {
      console.log("saving…");
      saveEditJs();
      myCodeMirrorUnsaved = false;
      if(e.key == 't') myCodeMirrorElStyle.visibility = "hidden";
      return e.preventDefault();
    }
  }
  else
  {
    if(e.key == 'e' && e.ctrlKey)
    {
      myCodeMirrorElStyle.visibility = "visible";
      return e.preventDefault();
    }
  }
});


document.addEventListener('keyup', (e) => {
  
  // console.log("keyup",e.key,e.ctrlKey);
  if(myCodeMirror.hasFocus())
  {
    return;
  }

  if(e.key == 'Escape')
  {
    clearHeaderSearch();
  }
  if(searchInput !== document.activeElement)
  {
    if(e.key == 'v')
    {
      var defaultMethod = selectedNode.$ex('object.defaultPageView');
      if(selectedMethod != defaultMethod)
        window.location.hash = selectedNode.name;
      else if(selectedMethod != 'simpleView')
        window.location.hash = selectedNode.name+'/simpleView';
      return e.preventDefault();
    }

    if(e.key == 'c')
    {
      if(selectedNode.$('instanceOf') == $$('collection'))
      {
        var mainContainingNode = selectedNode.$('mainContainingNode');
        if(mainContainingNode) window.location.hash = mainContainingNode.name;
      }
      else
      {
        var collection = selectedNode.$('collection');
        if(collection) window.location.hash = collection.name;
      }
      return e.preventDefault();
    }

    var menu = document.getElementsByClassName("menu")[0];
    // console.log(menu instanceof Element);
    // console.log(menu);
    var options = menu && menu.getElementsByClassName("option");
    options = options && Array.prototype.slice.call(options) || [];
    // console.log(options);

    options = options && options.map(option=>
      {
        var links = option.getElementsByTagName('a');
        var link = links && links[0];
        // console.log(link);
        // console.log(link.href);
        return link && link.href;
      });

    if(e.key == '.')               location.hash = "kaisHome";
    if(e.key == '0' && options[0]) window.location.href = options[0];
    else if(e.key == '0')          location.hash = "kaisHome";
    // if(e.key == '0'              ) location.hash = "kaisHome";
    // if(e.key == '9' && options[0]) location.hash = options[0].substring(1);
    // if(e.key == '6' && options[1]) location.hash = options[1].substring(1);
    // if(e.key == '3' && options[2]) location.hash = options[2].substring(1);
    if(e.key == '1' && options[1]) window.location.href = options[1];
    if(e.key == '2' && options[2]) window.location.href = options[2];
    if(e.key == '3' && options[3]) window.location.href = options[3];
  }
});




document.addEventListener("click", e=>
{
  var aEl = findParent('a',e.target || e.srcElement);
  if (!aEl) return;
  var url = aEl.href;
  var hash = url.split('#');
  if(hash.length == 0) return;
  hash = _.last(hash);
  if(hash.includes('/')) return; // TODO, maybe
  var node = $$(hash);
  if(!node) console.error("on click,","unknown node",hash);
  if(!node) return;
  if(e.shiftKey)
  {
    loggedUser.$('clipboard',node);
    console.log(node.$('prettyString'),"added to the clipboard");
    e.preventDefault();
    e.stopPropagation();
    clearHeaderSearch();
    return;
  }

  if(selectedMethod != 'simpleView'
    || searchResultsContainer.style.visibility == "visible")
  {
    var instanciable = node.$('instanceOf');
    if(instanciable && instanciable == $$('tag'))
    {
      var descriptor = makeUnique([
          ['object.instanceOf','descriptorFrom'],
          ['descriptorFrom.to',node],
          ['descriptorFrom.type','object.tags'],
        ])
      var collection = makeUnique([
          ['object.instanceOf','collection'],
          ['collection.descriptor',descriptor],
        ])
      showObject(collection);
      e.preventDefault();
      e.stopPropagation();
    }
    if(instanciable && instanciable == $$('YoutubeChannel'))
    {
      var descriptor = makeUnique([
          ['object.instanceOf','descriptorFrom'],
          ['descriptorFrom.to',node],
          ['descriptorFrom.type','YoutubeVideo.channel'],
        ])
      var collection = makeUnique([
          ['object.instanceOf','collection'],
          ['collection.descriptor',descriptor],
        ])
      showObject(collection);
      e.preventDefault();
      e.stopPropagation();
    }
  }
  console.log("clicked",url);
});

// content.appendChild(_instanciable.executeJsMethod($$('simpleView')));


































function bookmarkThis ()
{
  loggedUser.$('clipboard',selectedNode);
}

var _content = document.getElementById("content");
var selectedNode = _instanciable;
var selectedMethod;
var showObject = async (node,updateHash=true)=>
{
  clearHeaderSearch();

  // var method = 'object.simpleView';
  selectedMethod = undefined;
  if(!node) node = selectedNode;
  if(_.isString(node)) 
  {
    var split = node.split('/');
    if(split.length >= 2)
    {
      node = split[0];
      selectedMethod = split[1];
    }
    node = resolveIntoNode(node);
  }
  if(!node) node = selectedNode;
  selectedNode = node;
  var hash = node.name;
  var instanciable = node.$('instanceOf');
  // var defaultMethod = instanciable && instanciable.$('defaultPageView') || 'simpleView';
  // var defaultMethod2 = node.$('object.defaultPageView');
  var defaultMethod = node.$ex('object.defaultPageView');
  // if(defaultMethod2 != defaultMethod || defaultMethod3 != defaultMethod)
  //   console.error("showObject()",defaultMethod,defaultMethod2,defaultMethod3);
  if(!selectedMethod) selectedMethod = defaultMethod;
  if(selectedMethod != defaultMethod)
    hash+= '/'+selectedMethod;
  if(updateHash) location.hash = hash;
  var methodObject = strToType(selectedMethod,node);
  var html = methodObject && await node.$ex(methodObject);
  console.log("showObject()","LOAD",node.name,selectedMethod,'#'+hash,
    // "instanciable",instanciable&&instanciable.name,
    // 'defaultMethod2',defaultMethod2,
    "method",methodObject&&methodObject.name);
  // console.log("showObject()","LOAD",html);
  _content.innerHTML = '';

  // if(!method.includes('.')) method = '.'+method;
  // _content.appendChild(htmlToElement(  await Promise.resolve( $$(node,method) )  ));
  _content.appendChild(htmlToElement(  html  ));
  window.scrollTo({top:0});
}

var _selectedDescriptor = document.getElementById("selectedDescriptor");
var selectedDescriptor;
var updateSelectedDescriptor = descriptor=>
{
  console.log("updateSelectedDescriptor()","descriptor",descriptor);
  _selectedDescriptor.innerHTML = '';
  _selectedDescriptor.appendChild(htmlToElement($$(descriptor,'object.htmlSmallDescription')));

  selectedDescriptor = descriptor;
}
var editStringDescriptor = descriptor=>
{
  // if(!confirm('Are you sure?')) return;
  var value = $$(descriptor,"descriptorTo.resolve");
  var newString = prompt("string value:", value&&value.s);
  if(newString === null) return;
  $$( $$(descriptor,"descriptorTo.from"),$$(descriptor,"descriptorTo.type"),{s:newString} );
  showObjectFromHash();
}
// var editBooleanDescriptor = (descriptor,value)=>
// {
//   console.log("editBooleanDescriptor",descriptor.$('prettyString'),valueToString(value));
//   descriptor.$ex('insert',value);
//   // $$( $$(descriptor,"descriptorTo.from"),$$(descriptor,"descriptorTo.type"),{s:newString} );
//   showObjectFromHash();
// }
var insertIntoDescriptor = (descriptor,value)=>
{
  if(!confirm('Are you sure?')) return;
  console.log("insertIntoDescriptor",descriptor.$('prettyString'),valueToString(value));
  descriptor.$ex('insert',value);
  showObjectFromHash();
}
var editJavascriptDescriptor = descriptor=>
{
  var value = descriptor.$("resolve");
  var jsStr = value && value.j && String(value.j) || "function()\n{\n  \n}";
  console.log('editJavascriptDescriptor()',descriptor.$('prettyString'),jsStr);
  // document.getElementById("codeEditor").innerHTML = jsStr;
  myCodeMirror.setValue(jsStr);
  myCodeMirrorElStyle.visibility = "visible";
  myCodeMirrorUnsaved = false;
  myCodeMirror.focus();
  myCodeMirrorDescriptor = descriptor;

  // $$( $$(descriptor,"descriptorTo.from"),$$(descriptor,"descriptorTo.type"),{s:newString} );
  // showObjectFromHash();
}

var createField = (type,instanciable)=>
{
  if(!confirm('Are you sure?')) return;
  var claimtype = $$()
    .$('object.instanceOf','claimType')
    .$('claimType.typeFrom',instanciable)
    .$('claimType.typeTo',type);
  console.log("createField",type.$('prettyString'),instanciable.$('prettyString'));
  showObject(claimtype);
}

var saveEditJs = ()=>
{
  var js;
  try
  {
    js = eval('('+myCodeMirror.getValue()+')');
  }
  catch(e)
  {
    alert('could not compile js');
    console.error('saveEditJs()','could not compile js',e);
  }
  console.log('saveEditJs()',myCodeMirrorDescriptor.$('prettyString'),String(js));
  myCodeMirrorDescriptor.$ex('insert',{j:js});
}
var createInDescriptor = descriptor=>
{
  var instance = $$(descriptor,'descriptorFrom.instanciate');
  showObject(instance);
}

var showObjectFromHash = ()=>showObject(location.hash && location.hash.substring(1) || "instanciable",false);




// async function fetchYoutubePlaylist(playlistId,results=[],pageToken=undefined)
// {
//   console.log("fetchYoutubePlaylist()","pageToken",pageToken);
//   var path = 'https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&key=AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc&playlistId='+playlistId+'&maxResults=50';
//   if(pageToken) path+= '&pageToken='+pageToken;
//   var fetched = await fetch(path);
//   var json = await fetched.json();
//   json.items.forEach(item=>
//   {
//     var vid = item.snippet.resourceId.videoId;
//     console.log("fetchYoutubePlaylist()","videoId",vid);
//     results.push(vid);
//     $$(vid).$(_instanceOf,"YoutubeVideo").$('YoutubeVideo.title',{s:item.snippet.title});
//   });
//   if(json.nextPageToken) await fetchYoutubePlaylist(playlistId,results,json.nextPageToken);
//   return results;
//   // console.log("json",json);
// }
// async function fetchYoutubePlaylists(channelId,results=[],pageToken=undefined)
// {
//   console.log("fetchYoutubePlaylists()","pageToken",pageToken);
//   var path = 'https://www.googleapis.com/youtube/v3/playlists?part=snippet&key=AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc&channelId='+channelId+'&maxResults=50';
//   if(pageToken) path+= '&pageToken='+pageToken;
//   var fetched = await fetch(path);
//   var json = await fetched.json();
//   json.items.forEach(item=>
//   {
//     var pid = item.id;
//     console.log("fetchYoutubePlaylists()","playlistId",pid);
//     results.push(pid);
//     $$(pid).$(_instanceOf,"YoutubePlaylist").$('YoutubePlaylist.title',{s:item.snippet.title});
//   });
//   if(json.nextPageToken) await fetchYoutubePlaylists(channelId,results,json.nextPageToken);
//   return results;
//   // console.log("json",json);
// }

async function fetchYoutubeData(vid='IK7nBOLYzdE')
{
  var path = 'https://cors-anywhere.herokuapp.com/https://www.youtube.com/watch?v='+vid;
  var fetched = await fetch(path);

  var text = await fetched.text();
  var match = text.match(/window\[\"ytInitialPlayerResponse\"\] = (.*)/);
  if(!match) throw new Error('no json information found');

  var json = match[1];
  json = json.substring(0,json.length-1); // removes end ';'
  json = JSON.parse(json);

  // console.log('FOUND',json);
  // console.log('FOUND',JSON.stringify(json,null,'    '));

  var videoDetails = json.videoDetails;
  var microformat = json.microformat;
  var playerMicroformatRenderer = microformat.playerMicroformatRenderer;

  var processedJson = {};
  processedJson.fetchDate = new Date();
  processedJson.title = videoDetails.title;
  processedJson.lengthSeconds = Number(videoDetails.lengthSeconds);
  processedJson.averageRating = videoDetails.averageRating;
  processedJson.viewCount = Number(videoDetails.viewCount);
  processedJson.publishDate = new Date(playerMicroformatRenderer.publishDate);
  processedJson.uploadDate = new Date(playerMicroformatRenderer.uploadDate);
  processedJson.description = playerMicroformatRenderer.description.simpleText;
  processedJson.keywords = videoDetails.keywords;
  processedJson.channelId = videoDetails.channelId;
  processedJson.author = videoDetails.author;
  processedJson.ownerChannelName = playerMicroformatRenderer.ownerChannelName;

  var result = {};
  result.sourceHtml = text;
  result.extractedJson = json;
  result.processedJson = processedJson;

  return result;
}


(async ()=>
{
  await openClaimsDB();
  await loadClaimsForDB();
  // var fetched = await fetch('https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=PLfoEg9YVcQQS14MaRPjRdYM_Y-HwoQFPJ&key=AIzaSyByA7cXJD_3Hi8f2rTQ3loCyqIA6NfK9fc&pageToken=CAUQAQ&maxResults=5');
  // var json = await fetched.json();
  // console.log("json",json);

  console.log("Claims loaded from local indexedDB.");

  // in the background
  // importData('http://localhost:3000/all');
  // TODO await if db not initiated (can test .count() < 100)
  await importData('http://localhost:3000/all');
  console.log("Claims loaded from server.");

  loggedUser = $$('person').$froms('instanceOf').find(u=>u.$('title') == 'Kai Elvin');
  console.log("loggedUser",loggedUser&&loggedUser.$('title'));

  // var playlist = await fetchYoutubePlaylists('UCDDe2Yh15Yj4ljU_2f311mQ');
  // fetchYoutubePlaylist('PLfoEg9YVcQQS14MaRPjRdYM_Y-HwoQFPJ');

  window.addEventListener("hashchange", showObjectFromHash);
  showObjectFromHash();

  // var request = indexedDB.open("library");

  console.log(JSON.stringify(Claim.comb));
  console.log(_.sum(Claim.comb));

  // fetchYoutubeData('xWggTb45brM');
  // const items = await indexedDB.transaction('testStore').objectStore('testStore').getAll()
}
)();




var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
  // value: "function myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\nfunction myScript(){return 100;}\n",
  mode:  "javascript",
  extraKeys: {"Ctrl-Space": "autocomplete",
              "Ctrl-/": "toggleComment",
            },
  lineWrapping: true,
  lineNumbers: true,
  // autofocus: true,
  cursorScrollMargin: 2, // doesn't seem to work
  spellcheck: true,
  autocorrect: true,
  theme: "material-darker",
  scrollbarStyle: "overlay",
});

var myCodeMirrorUnsaved = false;
myCodeMirror.on('change',()=> myCodeMirrorUnsaved = true);



var myCodeMirrorElStyle = myCodeMirror.getWrapperElement().style;
myCodeMirrorElStyle.visibility = "hidden";
myCodeMirrorElStyle.position = "fixed";
myCodeMirrorElStyle.height = "auto";
myCodeMirrorElStyle.left = "10px";
myCodeMirrorElStyle.right = "10px";
myCodeMirrorElStyle.top = "50px";
myCodeMirrorElStyle.bottom = "50px";
var myCodeMirrorDescriptor;

</script>


    </body>
</html>